#!/bin/bash

# ะะฟัะตะดะตะปัะตะผ ะดะธัะตะบัะพัะธั, ะฒ ะบะพัะพัะพะน ะฝะฐัะพะดะธััั ัะบัะธะฟั
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"

# ะะตัะตะนัะธ ะฒ ะบะพัะตะฝั ะฟัะพะตะบัะฐ (ะดะธัะตะบัะพัะธั ัะบัะธะฟัะฐ)
cd "$SCRIPT_DIR" || { echo "โ ะะต ัะดะฐะปะพัั ะฟะตัะตะนัะธ ะฒ ะดะธัะตะบัะพัะธั ะฟัะพะตะบัะฐ: $SCRIPT_DIR"; exit 1; }
echo "โ ะะฐะฑะพัะฐั ะดะธัะตะบัะพัะธั: $(pwd)"
# ะัะพะฒะตััะตะผ, ัััะตััะฒัะตั ะปะธ celery_app.py
if [ ! -f "celery_app.py" ]; then
    echo "โ ะคะฐะนะป celery_app.py ะฝะต ะฝะฐะนะดะตะฝ ะฒ ัะตะบััะตะน ะดะธัะตะบัะพัะธะธ"
    exit 1
fi

# ะัะพะฒะตััะตะผ, ัััะตััะฒัะตั ะปะธ ะฒะธัััะฐะปัะฝะพะต ะพะบััะถะตะฝะธะต
if [ ! -d "venv" ]; then
    echo "โ ะะธัััะฐะปัะฝะพะต ะพะบััะถะตะฝะธะต 'venv' ะฝะต ะฝะฐะนะดะตะฝะพ"
    exit 1
fi

# ะะบัะธะฒะธัะพะฒะฐัั ะฒะธัััะฐะปัะฝะพะต ะพะบััะถะตะฝะธะต
source venv/bin/activate || { echo "โ ะะต ัะดะฐะปะพัั ะฐะบัะธะฒะธัะพะฒะฐัั ะฒะธัััะฐะปัะฝะพะต ะพะบััะถะตะฝะธะต"; exit 1; }

# ะกะพะทะดะฐัั ะฟะฐะฟะบั ะดะปั ะปะพะณะพะฒ (ะตัะปะธ ะตั ะฝะตั)
mkdir -p logs

# ะััะฐะฝะพะฒะธัั ััะฐััะต ะฟัะพัะตััั
echo "๐ ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ััะฐััะต ะฟัะพัะตััั Celery..."
pkill -f 'celery.*worker' || echo "โน๏ธ ะะตั ะทะฐะฟััะตะฝะฝัั ะฒะพัะบะตัะพะฒ"
pkill -f 'celery.*beat' || echo "โน๏ธ ะะตั ะทะฐะฟััะตะฝะฝะพะณะพ beat"

# ะะฐัะทะฐ, ััะพะฑั ะฟัะพัะตััั ัะพัะฝะพ ะทะฐะฒะตััะธะปะธัั
sleep 2

# ะะฐะฟัััะธัั Celery Worker
echo "๐ ะะฐะฟััะบะฐะตะผ Celery Worker..."
nohup celery -A celery_app worker --loglevel=info >> logs/worker.log 2>&1 &

# ะะฐะฟัััะธัั Celery Beat
echo "๐ ะะฐะฟััะบะฐะตะผ Celery Beat..."
nohup celery -A celery_app beat --loglevel=info >> logs/beat.log 2>&1 &

# ะะพัะพะฒะพ
echo "โ Celery Worker ะธ Beat ััะฟะตัะฝะพ ะทะฐะฟััะตะฝั."
echo "๐ ะะพะณะธ: logs/worker.log ะธ logs/beat.log"
